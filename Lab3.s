GPIO_PORTA_CRL EQU 0x40010800
GPIO_PORTB_CRL EQU 0x40010C00
GPIO_PORTA_ODR EQU 0x4001080C
GPIO_PORTB_ODR EQU 0x40010C0C
GPIO_PORTA_IDR EQU 0x40010808
GPIO_PORTB_IDR EQU 0x40010C08
RCC EQU 0x40021000


   AREA mycode, CODE, READONLY
   EXPORT __main
	ENTRY

__main  

; Your Initialization goes here
   LDR R0,=RCC
   MOV32 R1, #0x0C ;activate clock for Port E
   STR R1,[R0, #0x18] ;RCC_APB2RSTR
	
   ; A0, A1: input pull down
   LDR R0, =GPIO_PORTA_CRL
   LDR R1, [R0]
   MOV32 R1,#0x088
   STR R1, [R0] 

   LDR R0, =GPIO_PORTA_ODR
   LDR R1, [R0]
   MOV32 R1,#0x00
   STR R1, [R0]

   ; B0: out put push pull
   LDR R0, =GPIO_PORTB_CRL
   LDR R1, [R0]
   MOV32 R1, #0x02
   STR R1,[R0]

   LDR R0, =GPIO_PORTB_ODR
   LDR R1, [R0]
   MOV32 R1, #0x00
   STR R1,[R0]
	
   MOV R2, #30 
loop
	LDR R0, =GPIO_PORTA_IDR ;check change switch
   LDR R1, [R0]
   ANDS R1, R1, #0x02
   CMP R1, #0x02
   BNE default
   BAL ChangePressed

changeduty
   ADD R2, R2, #5
   CMP R2, #100
   BLS default
   MOV R2,#10
   B default

ChangePressed
   BL toggle
   LDR R0, =GPIO_PORTA_IDR
   LDR R1, [R0]
   ANDS R1, R1, #0x02
   CMP R1, #0x01
   BNE changeduty
   B ChangePressed



default
   LDR R0, =GPIO_PORTA_IDR
   LDR R1, [R0]
   ANDS R1, R1, #0x01
   CMP R1, #0x01
   BEQ breathePressed
   BL toggle
	B loop

breathePressed
    LDR R0, =GPIO_PORTA_IDR
    LDR R1, [R0]
    ANDS R1, R1, #0x01
    CMP R1, #0x01
    BNE default
    BL breathe
    B breathePressed

breathe
   LDR R0, =PerlinTable
   ADD r1,r0,#512
   push{LR}
for 
   CMP R0,R1
   BGE done
   LDRH R3,[R0]
   BL breathloop
   ADD R0,R0,#2
	B for

done
   pop {LR}
   BX LR

breathloop
   push {LR,R1}
   LDR R4, =GPIO_PORTA_ODR
   LDR R6, [R4]
   MOV32 R6, #0x01
   STR R6, [R4]

	MOV R1,R3
   BL Delay
   LDR R4, =GPIO_PORTA_ODR
   LDR R6, [R4]
   MOV32 R6, #0x00
   STR R6, [R4]

	MOV32 R4,#10000
	SUB R1, R4, R3
   BL Delay
   pop{LR,R1}
   BX LR



toggle
   LDR R0,=GPIO_PORTB_ODR
   LDR R1,[R0]
   MOV R1, #0x01 ;set PB0 = 1
   STR R1,[R0]
	

   MOV R3, #20
	MUL R1, R2, R3
	push {lr}
   BL DelayFunc

   LDR R0,=GPIO_PORTB_ODR
   LDR R1,[R0]
   MOV R1, #0x00 ;set PB0 = 0 
   STR R1,[R0]
	
   MOV R5, #100
	SUB R5, R5, R2
	MUL R1, R5, R3
   BL DelayFunc
	pop {lr}
   BX LR
    
DelayFunc
	MOV32 R5, #1000
	MUL R1, R1, R5
Delay NOP ;dummy operation 8cycle->1v 100ns->5000000
      NOP
      NOP
      NOP
      SUBS R1,R1,#1
      BNE  Delay
      BX   LR

   ALIGN 4
; 256 points with values from 100 to 9900      
PerlinTable
      DCW 5880,6225,5345,3584,3545,674,5115,598,7795,3737,3775,2129,7527,9020,368,8713,5459,1478,4043,1248,2741,5536,406
      DCW 3890,1516,9288,904,483,980,7373,330,5766,9555,4694,9058,2971,100,1095,7641,2473,3698,9747,8484,7871,4579,1440
      DCW 521,1325,2282,6876,1363,3469,9173,5804,2244,3430,6761,866,4885,5306,6646,6531,2703,6799,2933,6416,2818,5230,5421
      DCW 1938,1134,6455,3048,5689,6148,8943,3277,4349,8866,4770,2397,8177,5191,8905,8522,4120,3622,1670,2205,1861,9479
      DCW 1631,9441,4005,5574,2167,2588,1057,2512,6263,138,8369,3163,2895,8101,3009,5153,7259,8063,3507,789,6570,7756,7603
      DCW 5268,5077,4541,7297,6187,3392,6378,3928,4273,7680,6723,7220,215,2550,2091,8407,8752,9670,4847,4809,291,7833,1555
      DCW 5727,4617,4923,9862,3239,3354,8216,8024,7986,2359,8790,1899,713,2320,751,7067,7335,1172,1708,8637,7105,6608,8254
      DCW 4655,9594,5919,177,1784,5995,6340,2780,8560,5957,3966,6034,6493,1746,6684,445,5038,942,1593,9785,827,3852,4234
      DCW 4311,3124,4426,8675,8981,6914,7182,4388,4081,8445,9517,3813,8828,9709,1402,9364,7488,9211,8139,5613,559,7412
      DCW 6952,6302,9326,3201,2052,5651,9096,9632,636,9249,4196,1976,7450,8292,1287,7029,7718,4158,6110,7144,3316,7909
      DCW 6838,4502,4732,2014,1823,4962,253,5842,9823,5383,9134,7948,3660,8598,4464,2665,1210,1019,2856,9402,5498,5000
      DCW 7565,3086,2627,8330,2435,6072,6991
      
      ALIGN      ; make sure the end of this section is aligned
      END        ; end of file
